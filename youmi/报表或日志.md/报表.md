[ADN合并前报表数据的来龙去脉](https://git.umlife.net/adxmi/adn/blob/master/doc/old-settle/README.md)
[字段](https://conf.umlife.net/pages/viewpage.action?pageId=51642386)
### ADN报表

1. 记录某广告的数据：如今日展示了多少次、点击了多少次（日数据、月数据等）
2. 记录某应用（媒介）的某广告数据：如今日展示了多少次、点击了多少次（日数据、月数据等）->应用日收益
3. 记录某父渠道的数据：应用-广告-日数据->父渠道日收益


根据以上数据，计算得到各方收益
1. 某应用的日收益
2. 某账号（该账号可能拥有多个应用）的日收益
3. 某父渠道的日收益
4. 更新各方账号余额，并添加账号余额变更记录

### ADX报表（精确到小时）
竞价id-媒介-广告位-开发者收入-dspid-竞价结果。根据这些信息计算媒介、广告主每小时竞价情况

### Mediation报表
第三方平台reporting api数据


# ADN合并前报表数据的来龙去脉

## 报表

报表可以分为

* ADN报表
* Medation报表
* ADX报表（目前暂时用redash顶替）
* 订单

### ADN报表

#### 报表
ADN合并前报表数据的来龙去脉
* https://git.umlife.net/adxmi/adn/edit/master/doc/old-settle/README.md

* https://conf.umlife.net/pages/viewpage.action?pageId=51643540


| table                                    | desc                        |
|------------------------------------------|-----------------------------|
| `youmi_stat`.`app_ad_day_country_record` | 国家-媒介-广告-日数据       |
| `youmi_stat`.`app_ad_day_record`         | 媒介-广告-日数据            |
| `youmi_stat`.`ad_day_cost`               | 广告-日数据                 |
| `youmi_stat`.`app_day_income`            | 媒介-日数据                 |
| `youmi_stat`.`app_income_summary`        | 媒介-日收益数据             |
| `youmi_stat`.`user_day_income`           | 账号-日收益数据             |
| `youmi_stat`.`aff_day_income`            | 父渠道账号-媒介-广告-日数据 |
| `youmi_stat`.`aff_income_summary`        | 父渠道账号-日收益数据       |
| `youmi_app`.`app_info`                   | 账号余额                    |
| `youmi_stat`.`app_acount`                | 账号余额变更记录            |

注意

* 如果开发者聚合第三方SDK的时候没有与我们分成的话，这部分开发者收入和广告主支出是不会记录到ADN报表的，但是请求、点击、展示还是会记录的.
* 如果一条记录中的ctid为0，说明这条记录只针对aid的进行计数，例如请求配置这个动作是跟广告无关的

#### pay_type

报表中通过`pay_type`来表示该记录是针对哪一个动作的记录，常用的有

| pay_type | action       |
|----------|--------------|
| 0        | 请求         |
| 1        | 展示         |
| 2        | 点击         |
| 11       | 广告主回调   |
| 20       | 视频开始播放 |
| 21       | 视频播放完成 |
| 32       | 请求配置     |


#### xcount

| xcount | desc             |
|--------|------------------|
| ucount | 对开发者的总量   |
| ocount | 对广告主的总量   |
| vcount | 对开发者有效的量 |
| pcount | 对开发者付费的量 |
| acount | 对广告主有效的量 |
| ccount | 对广告主付费的量 |

注意

* `ucount`是新增表`youmi_stat`.`app_ad_day_country_record`的时候增加的，原本对开发者的总量和对广告主的总量都是`ocount`. 因此`youmi_stat`.`app_ad_day_record`的`ocount`对应`youmi_stat`.`app_ad_day_country_record`的`ucount`

各个产品的各个动作对xcount的影响

| 产品                                   | 动作                                   | 与ctid无关 | zbus日志一行是否可能有多个ctid | 附加条件                               | ucount | ocount                 | vcount | pcount | acount | ccount |
|----------------------------------------|----------------------------------------|------------|--------------------------------|----------------------------------------|--------|------------------------|--------|--------|--------|--------|
| API                                    | 请求                                   | 是         |                                |                                        | +1     |                        | +1     |        |        |        |
| API                                    | 点击                                   | 否         |                                |                                        | +1     | +1                     | +1     | +1     |        |        |
| API                                    | 广告主回调                             | 否         |                                | 正常结算                               | +1     | +1                     | +1     | +1     | +1     | +1     |
| API                                    | 广告主回调                             | 否         |                                | 扣量/防作弊/...                        |        | +1                     |        | +1     |        | +1     |
| VBA                                    | 请求                                   | 否         | 是                             | 第一个ctid                             | +1     | +1                     | +1     | +1     |        |        |
| VBA                                    | 请求                                   | 否         | 是                             | 非第一个ctid                           |        | +1                     |        | +1     |        |        |
| VBA                                    | 点击                                   | 否         |                                |                                        | +1     | +1                     | +1     | +1     |        |        |
| VBA                                    | 广告主回调                             | 否         |                                | 正常结算                               | +1     | +1                     | +1     | +1     | +1     | +1     |
| VBA                                    | 广告主回调                             | 否         |                                | 扣量/防作弊/...                        |        | +1                     |        | +1     |        | +1     |
| 聚合插屏/聚合原生/聚合视频             | 请求配置                               | 是         |                                |                                        | +1     |                        | +1     |        |        |        |
| 聚合插屏/聚合原生（非推荐墙）/聚合视频 | 请求（event_id=0 请求成功)             | 否         |                                | 第三方平台                             | +1     | +1                     | +1     | +1     |        |        |
| 聚合插屏/聚合原生（非推荐墙）/聚合视频 | 请求（event_id=0 请求成功)             | 否         |                                | 第一个自家平台                         | +1     | +1                     | +1     | +1     |        |        |
| 聚合插屏/聚合原生（非推荐墙）/聚合视频 | 请求（event_id=0 请求成功)             | 否         |                                | 非第一个自家平台                       |        | +1                     | +1     | +1     |        |        |
| 推荐墙                                 | 请求（event_id=0 请求成功)             | 否         | 是                             | 第一个ctid                             | +1     | +1                     | +1     | +1     |        |        |
| 推荐墙                                 | 请求（event_id=0 请求成功)             | 否         | 是                             | 非第一个ctid                           |        | +1                     |        | +1     |        |        |
| 聚合插屏/聚合原生/聚合视频             | 请求（event_id=1 请求失败)             | 否         |                                | 第三方平台                             | +1     | +1                     |        |        |        |        |
| 聚合插屏/聚合原生/聚合视频             | 请求（event_id=1 请求失败)             | 否         |                                | 第一个自家平台                         | +1     | +1                     |        |        |        |        |
| 聚合插屏/聚合原生/聚合视频             | 请求（event_id=1 请求失败)             | 否         |                                | 非第一个自家平台                       |        | +1                     |        |        |        |        |
| 聚合插屏/聚合原生/聚合视频             | 展示（event_id=2 展示成功)             | 否         |                                | provider=rtb                           | +1     | +1                     | +1     | +1     | +1     | +1     |
| 聚合插屏/聚合原生（非推荐墙）          | 展示（event_id=2 展示成功)             | 否         |                                | provider=adxmi 且 配置ecpm自动补收益   | +1     | +1                     | +1     | +1     | +1     |        |
| 聚合插屏/聚合原生（非推荐墙）          | 展示（event_id=2 展示成功)             | 否         |                                | provider!=adxmi,rtb 或 没有配置ecpm自动补收益 | +1     | +1     | +1     | +1     |  |  |
| 聚合视频                               | 展示（event_id=2 展示成功)             | 否         |                                | provider!=rtb                          | +1     | +1                     | +1     | +1     |        |        |
| 推荐墙                                 | 展示（event_id=2 展示成功)             | 否         | 是                             | 第一个ctid                             |        | +1                     | +1     | +1     |        |        |
| 推荐墙                                 | 展示（event_id=2 展示成功)             | 否         | 是                             | 非第一个ctid                           |        | +1                     |        | +1     |        |        |
| 推荐墙                                 | 展示（event_id=11 墙展示)              | 是         |                                | 配置ecpm自动补收益                     | +1     |                        |        |        | +1     |        |
| 推荐墙                                 | 展示（event_id=11 墙展示)              | 是         |                                | 没有配置ecpm自动补收益                 | +1     |                        |        |        |        |        |
| 聚合插屏/聚合原生/聚合视频             | 展示（event_id=3 展示失败)             | 否         |                                | 第三方平台                             | +1     | +1                     |        |        |        |        |
| 聚合插屏/聚合原生/聚合视频             | 点击（event_id=4 点击行为)             | 否         |                                |                                        | +1     | +1                     | +1     | +1     |        |        |
| 聚合插屏/聚合原生/聚合视频             | 点击（event_id=5 (重定向)              | 否         |                                |                                        |        |                        |        |        |        |        |
| 聚合视频                               | 视频开始播放（event_id=7 视频开始播放) | 否         |                                |                                        | +1     | +1                     | +1     | +1     |        |        |
| 聚合视频                               | 视频播放完成（event_id=8 视频播放完成) | 否         |                                | provider=adxmi 且 配置ecpm自动补收益   | +1     | +1                     | +1     | +1     | +1     |        |
| 聚合视频                               | 视频播放完成（event_id=8 视频播放完成) | 否         |                                | provider!=adxmi 或 没有配置ecpm自动补收益 | +1     | +1     | +1     | +1     |  |  |
| 聚合插屏/聚合原生/聚合视频             | 广告主回调                             | 否         |                                | 正常结算                               | +1     | +1                     | +1     | +1     | +1     | +1     |
| 聚合插屏/聚合原生/聚合视频             | 广告主回调                             | 否         |                                | 扣量/防作弊/已按ecpm自动补收益...      |        | +1                     |        | +1     |        | +1     |

注意

* 聚合对多个自家平台的请求只算一次对开发者的总量ucount(请求数)，这样算填充率的时候才不会显得太低
* 推荐墙一次请求20条广告只算一次对开发者的总量(请求数)和对开发者有效的量（请求成功数）
* 推荐墙的广告展示事件不计展示数，墙的打开事件才算展示数

#### 报表的数据的来源

* 接口实时结算: 广告主回调/展示结算时，发送upsert增量更新任务(会写income和cost)
* 日志分析脚本: log_00 crontab有很多分析zbus分钟日志的脚本，它会解析日志，发送upsert增量更新任务(不写income和cost)
* ReportingAPI: 后台拉取第三方RepotingAPI，发送upsert全量更新任务(只写income和cost)

upsert消费任务并写入`youmi_stat`.`app_ad_day_country_record`和`youmi_stat`.`aff_day_income`

注意

* 接口实时结算的时候也会写zbus日志，为避免重复写入数据，在脚本解析日志的时候，如果发现ocount为1，说明这条日志已经在接口实时结算发送过upsert任务，不用再处理
* 接口实时结算和日志分析脚本分别发送upsert任务的原因是，目前还不能保证日志不会被重复消费（比如脚本跑了一半蹦崩溃了，当前处理的日志文件还在，重跑又把日志重复消费一遍）。因此日志分析脚本写upsert的时候不会写income和cost的，跟钱有关的由实时结算时写入

#### 账号余额变动

现在`youmi_stat`.`app_ad_day_country_record`和`youmi_stat`.`aff_day_income`已经有广告数据了，那么开发者账号的余额是如何变动的呢？

首先有一个定时脚本将大表数据汇到小表数据

[点击查看UML图](./db_all_events.svg)

处理正常广告收入带来的余额变动的脚本

[点击查看UML图](./c_m_app_day_pay.svg)

处理渠道分成带来的余额变动的脚本

[点击查看UML图](./c_m_aff_day_pay.svg)

### Mediation报表

提供报表供开发者查询数据使用。

报表中的数据不一定跟我们平台有关。例如开发者自己申请Facebook账号，使用我们的聚合SDK进行变现。我们只是帮开发者将Facebook的数据拉回来保存，方便他们在我们主站上统一查询，但是这部分流水跟我们其实没有关系

#### 报表

| table                          | desc               |
|--------------------------------|--------------------|
| `youmi_olap`.`app_ad_day_stat` | 广告位-平台-日数据 |
| `youmi_olap`.`app_ad_min_stat` | 废弃               |

#### Schema

https://conf.umlife.net/pages/viewpage.action?pageId=46243020

表中source=1表示该数据是由我们平台统计写入的，source=2表示该数据是通过拉取第三方reporting-api写入的

从联盟拉取的广告是没有reporting-api可以拉取广告的出量数据的，因此为了主站展示方便以及reporting-api（luna）查询方便，从联盟拉取的广告的数据，会双写source=1和source=2。这样，主站和luna查询的时候只要查source=2的数据就可以了。

#### 报表数据的来源

* 日志分析脚本: log_00 crontab有很多分析zbus分钟日志的脚本，它会解析日志，发送upsert增量更新任务
* ReportingAPI: 后台拉取第三方RepotingAPI，发送upsert全量更新任务

upsert消费任务并写入`youmi_stat`.`app_ad_day_stat`

注意

* 聚合对多个自家平台的请求只算一次对开发者的总量ucount(请求数)，这样算填充率的时候才不会显得太低
* 推荐墙一次请求20条广告只算一次对开发者的总量(请求数)和对开发者有效的量（请求成功数）
* 推荐墙的广告展示事件不计展示数，墙的打开事件才算展示数

### ADX报表

https://conf.umlife.net/pages/viewpage.action?pageId=46243024

用来保存聚合广告中RTB广告的数据

目前仅将数据保存到redash，没有做mysql报表



### 订单

订单主要用来记录某一次结算时候的情况，主要是用来查不给开发者结算的原因(防作弊、只能扣量...)，以及查结算时回调给开发者的链接

中间层接口实时结算的时候会通过zbus将订单信息写到log00上

log00上有一个项目:https://git.umlife.net/adxmi-plat/sync_ymorders ，会解析日志，将订单保存单redshift，以及转成avro上传到s3，因此目前订单的存储比较冗余，持久化的流程也比较繁琐

白色后台导出订单的功能目前是从redshift中查询订单信息的

#### 订单Schema

https://conf.umlife.net/pages/viewpage.action?pageId=46243105
