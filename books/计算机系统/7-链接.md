&#8195;&#8195;自从换了工作以后，学习、阅读的时间就相对减少了，日益觉得自己面目可憎了。

<p align="center">
<img src="../img/广州灯光节.jpeg" alt="广州灯光节" width="500"/>
</p>

&#8195;&#8195;链接是将各种代码和数据片段手机并组合成为一个单一温江的过程，这个文件可被加在到内存并执行。链接可以执行于编译时，也就是在源代码被翻译成机器代码时；也可以执行于加载时，也就是在程序被加载起加在到内存执行时；甚至执行于运行时，也就是由应用程序来执行。在现代系统中，链接是由叫链接器的程序自动执行的。

&#8195;&#8195;为什么要了解连接器：
- 理解连接器将帮助你构建大型程序
- 理解链接器将帮助你避免一些危险的编程错误
- 理解连接器将帮助你理解语言的作用域规则是如何实现的
- 理解链接将是你利用共享库（或者链接库的工作原理）

下文的例子、内容使用c语言为例，其他语言也是大同小异。

## 编译器驱动程序
<p align="center">
<img src="../img/linking.png" alt="编译过程" width="350"/>
</p>

&#8195;&#8195;大多数编译系统提供编译器驱动程序，它代表用户在需要时调用语言预处理器、编译器、汇编器和连接器。

- 驱动程序手下运行C预处理器，它将c的源程序main.c翻译成一个ASCII码的中间文件main.i。命令如下：cpp main.c main.i
- 接下来运行c编译器，它将main.i翻译成一个ASCII汇编语言文件main.s。命令如下：cc1 main.i -Og -o main.s
- 然后运行汇编器as，它将main.s翻译成一个可重定位目标文件(文件内引用的外部变量、外部函数、外部库尚待链接器来定位加载)。命令如下：as -o main.o main.s
- 最后运行连接器ld，将main.o和sum.o以及一些必要的系统目标文件组合起来，创建一个可执行目标文件。命令如下：ld -o main main.o sum.o

&#8195;&#8195;运行时，shell调用操作系统一个叫加载器（loader）的函数，来将可执行文件中的代码和数据复制到内存，然后将控制权转移到程序的开头。


## 静态链接
想linux LD程序这样静态链接器以一组可重定位目标文件和命令行参数作为输入，生成一个完全链接的、可以加载和运行的可执行目标文件作为输出。输出的可重定位目标温江由各种不同的代码和数据节组成。

为了狗仔可执行文件，连接器必须完成以下两个主要任务：
- 符号解析：每个符号对应于一个函数、一个全局变量或者一个静态变量。符号解析的目的是将每个符号引用正好和一个符号定义关联起来。
- 重定位：编译器和汇编器生成从地址0开始的代码和数据节。链接器通过把每个符号定义和一个内存位置关联起来，从而重定位这些节。

## 目标文件
目标文件有三种形式：
- 可重定位目标文件：包含二进制代码和数据，其形式可以在编译时和其他可重定位目标文件合并起来，创建一个可执行目标文件
- 可执行目标文件。包含二进制代码和数据，其形式可以被直接复制到内存并执行
- 共享目标文件。一种特殊类型的可重定位目标文件，可以在加载或者运行时被动态地加载进内存并链接。（java的动态加载的基本原理也类似如此）

编译器、汇编器生成可重定位目标文件（包括共享目标文件）。链接器生成可执行目标文件。

## 可重定位目标文件
<p align="center">
<img src="../img/reloactable_target_file.png " alt="编译过程" width="200"/></p>

- ELF header开头的16个字节描述生成改文件的系统的字的大小和字节顺序。剩余部分包含帮助链接器语法分析和解析目标文件的信息，如ELF header 的大小、目标文件类型（可重定位/可执行/可共享）、机器类型（x86-64）、节头部表的文件偏移等。
- .text：已编译程序的机器代码
- .rodata：只读数据，比如printf语句中的格式串和开关语句的跳转表
- .data：已初始化的全局和静态C变量
- .bss：未初始化的全局和静态C变量，以及所有被初始化未0的全局和静态变量
- .symtab: 一个符号表，它存放了程序汇中定义和引用的函数和全局变量的信息
- .rel.txt: 一个.txext节中位置的列表，当连接器把这个目标文件和其他文件组合时，需要修改这些位置。即函数表
- .rel.data：被模块引用或定义的所有全局变量的重定位信息。即外部数据表
- .debug：一个调试符号表，其条目是程序中定义的局部变量和类型定义、程序中定义和引用的全局变量表、原始的c源文件。只有在编译时使用 -g 选项才会得到这张表
- .line：程序中的行号和.text节中机器指令之间的映射，只有以-g选项调用编译器驱动程序才会得到这张表（程序运行中可以打印代码行号也是基于这个表）
- .strtab：一个字符串表，其内容包括.symtab和.debug中的符号表


## 符号和符号表
